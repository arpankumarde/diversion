"""curl_cffi TLS-safe HTTP client for exploitation."""

from __future__ import annotations

import logging

from curl_cffi.requests import AsyncSession

from nazitest.models.exploit import ExploitResponse, ExploitStrategy

logger = logging.getLogger(__name__)


class CurlExploiter:
    """TLS-fingerprint-safe HTTP client for exploitation.

    Uses curl_cffi to impersonate real browser TLS signatures.
    """

    def __init__(self, proxy_url: str | None = None) -> None:
        self.proxy_url = proxy_url

    async def execute(
        self,
        strategy: ExploitStrategy,
        cookies: dict[str, str] | None = None,
    ) -> ExploitResponse:
        """Execute an exploit strategy and return the response."""
        proxies = {"https": self.proxy_url, "http": self.proxy_url} if self.proxy_url else None

        async with AsyncSession(
            impersonate=strategy.impersonate,
            proxies=proxies,
            verify=True,
        ) as session:
            # Set cookies
            if cookies:
                for name, value in cookies.items():
                    session.cookies.set(name, value)

            try:
                response = await session.request(
                    method=strategy.http_method.value,
                    url=strategy.url,
                    headers=strategy.headers or None,
                    data=strategy.body.encode() if strategy.body else None,
                    params=strategy.params or None,
                    allow_redirects=strategy.follow_redirects,
                    timeout=strategy.timeout,
                )

                return ExploitResponse(
                    status=response.status_code,
                    headers=dict(response.headers),
                    body=response.text[:50000],  # Cap body size
                    elapsed_ms=response.elapsed * 1000 if response.elapsed else 0,
                    tls_version=(
                        str(response.http_version)
                        if hasattr(response, "http_version") else ""
                    ),
                )
            except Exception as e:
                logger.error("Exploit request failed: %s", e)
                return ExploitResponse(
                    status=0,
                    body=f"Error: {e}",
                )
