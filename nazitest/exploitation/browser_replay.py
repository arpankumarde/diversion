"""Browser-based exploit replay for client-side vulnerabilities (XSS, CSRF)."""

from __future__ import annotations

import logging

from nazitest.models.exploit import ExploitResponse, ExploitStrategy
from nazitest.recon.browser import BrowserController

logger = logging.getLogger(__name__)


class BrowserReplay:
    """Executes browser-based exploits via Zendriver.

    Used for client-side vulnerabilities that require JS execution.
    """

    def __init__(self, browser: BrowserController) -> None:
        self.browser = browser

    async def execute(
        self,
        strategy: ExploitStrategy,
        cookies: dict[str, str] | None = None,
    ) -> ExploitResponse:
        """Execute an exploit strategy in the browser."""
        try:
            # Navigate to the target URL
            await self.browser.navigate(strategy.url)

            # Inject cookies if needed
            if cookies:
                for name, value in cookies.items():
                    await self.browser.evaluate(
                        f"document.cookie = '{name}={value}; path=/';"
                    )

            # If there's a payload, try to inject it
            if strategy.payload:
                result = await self.browser.evaluate(strategy.payload)
                body = str(result) if result else ""
            else:
                body = await self.browser.get_page_html()

            current_url = await self.browser.get_page_url()

            return ExploitResponse(
                status=200,
                headers={"location": current_url},
                body=body[:50000],
            )

        except Exception as e:
            logger.error("Browser replay failed: %s", e)
            return ExploitResponse(
                status=0,
                body=f"Error: {e}",
            )
