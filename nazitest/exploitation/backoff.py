"""Exponential backoff with jitter â€” used when exploits are blocked."""

from __future__ import annotations

import asyncio
import logging
import random

logger = logging.getLogger(__name__)


class BackoffManager:
    """Exponential backoff with jitter per PRD section 9."""

    def __init__(self, max_delay: float = 5.0, jitter_ratio: float = 0.3) -> None:
        self.max_delay = max_delay
        self.jitter_ratio = jitter_ratio

    def calculate_delay(self, attempt: int) -> float:
        """Calculate delay for the given attempt number."""
        base_delay = min(2**attempt, self.max_delay)
        jitter = random.uniform(0, base_delay * self.jitter_ratio)
        return base_delay + jitter

    async def wait(self, attempt: int) -> float:
        """Wait with exponential backoff. Returns the actual delay used."""
        delay = self.calculate_delay(attempt)
        logger.info("Backoff: waiting %.1fs (attempt %d)", delay, attempt)
        await asyncio.sleep(delay)
        return delay
