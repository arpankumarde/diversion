"""Exploitation models — strategies, results, PoCs."""

from __future__ import annotations

import json

from pydantic import BaseModel, Field

from nazitest.models.types import DeliveryMethod, EncodingType, ExploitMethod, HttpMethod, Severity


class ExploitStrategy(BaseModel):
    """A planned exploit attempt."""

    hypothesis_id: str
    method: ExploitMethod = ExploitMethod.CURL_CFFI
    http_method: HttpMethod = HttpMethod.GET
    url: str
    headers: dict[str, str] = Field(default_factory=dict)
    body: str | None = None
    params: dict[str, str] = Field(default_factory=dict)
    payload: str = ""
    encoding: EncodingType = EncodingType.RAW
    delivery: DeliveryMethod = DeliveryMethod.QUERY_PARAM
    follow_redirects: bool = True
    timeout: float = 30.0
    impersonate: str = "chrome131"
    description: str = ""

    def to_poc_script(self) -> str:
        """Generate a standalone PoC script for this strategy."""
        lines = [
            "#!/usr/bin/env python3",
            '"""Auto-generated PoC — NAZITEST"""',
            "",
            "from curl_cffi.requests import Session",
            "",
            f"url = {json.dumps(self.url)}",
        ]
        if self.headers:
            lines.append(f"headers = {json.dumps(self.headers)}")
        if self.body:
            lines.append(f"data = {json.dumps(self.body)}")
        if self.params:
            lines.append(f"params = {json.dumps(self.params)}")
        lines.append("")
        lines.append(f"with Session(impersonate={json.dumps(self.impersonate)}) as s:")
        parts = [f'    r = s.{self.http_method.value.lower()}(url']
        if self.headers:
            parts.append(", headers=headers")
        if self.body:
            parts.append(", data=data")
        if self.params:
            parts.append(", params=params")
        parts.append(")")
        lines.append("".join(parts))
        lines.append("    print(r.status_code)")
        lines.append("    print(r.text[:2000])")
        return "\n".join(lines)


class ExploitResponse(BaseModel):
    """Raw response from an exploit attempt."""

    status: int
    headers: dict[str, str] = Field(default_factory=dict)
    body: str = ""
    elapsed_ms: float = 0
    tls_version: str = ""


class ExploitAttempt(BaseModel):
    """Record of a single exploit attempt."""

    attempt_number: int
    strategy: ExploitStrategy
    response: ExploitResponse | None = None
    success: bool = False
    blocked: bool = False
    inconclusive: bool = False
    error: str = ""


class ExploitResult(BaseModel):
    """Final result of exploitation for a hypothesis."""

    hypothesis_id: str
    confirmed: bool = False
    severity: Severity = Severity.MEDIUM
    attempts: list[ExploitAttempt] = Field(default_factory=list)
    poc_script: str = ""
    evidence_summary: str = ""
    remediation: str = ""


class PoC(BaseModel):
    """A standalone proof-of-concept."""

    hypothesis_id: str
    title: str
    description: str
    script: str
    vuln_type: str
    severity: Severity = Severity.MEDIUM
    steps_to_reproduce: list[str] = Field(default_factory=list)
    impact: str = ""
    remediation: str = ""
