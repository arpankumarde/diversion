import { NextRequest, NextResponse } from "next/server";
import { openai } from "@/lib/openai";

function isValidId(id: string): boolean {
  return /^[a-zA-Z0-9_-]+$/.test(id) && !id.includes("..");
}

export async function POST(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> },
) {
  const { id } = await params;
  if (!id || !isValidId(id)) {
    return NextResponse.json({ error: "Invalid report ID" }, { status: 400 });
  }

  let vulnerability: Record<string, unknown>;
  try {
    vulnerability = await req.json();
  } catch {
    return NextResponse.json({ error: "Invalid JSON body" }, { status: 400 });
  }

  const title = String(vulnerability.title ?? "Unknown");
  const description = String(vulnerability.description ?? "");
  const severity = String(vulnerability.severity ?? "");
  const vulnType = String(vulnerability.vuln_type ?? "");
  const endpoint = String(vulnerability.endpoint ?? "");
  const cweId =
    vulnerability.cwe_id != null ? String(vulnerability.cwe_id) : "";
  const cveIds = Array.isArray(vulnerability.cve_ids)
    ? vulnerability.cve_ids.map(String).join(", ")
    : vulnerability.cve_id != null
      ? String(vulnerability.cve_id)
      : "";

  const systemPrompt = `You are a security expert explaining vulnerabilities to a product manager. Use clear, non-technical language where possible. Focus on business impact, risk, and what actions the product team should take. Be concise but thorough.`;

  const userPrompt = `Explain this security vulnerability as if to a product manager:

**Title:** ${title}
**Severity:** ${severity}
${vulnType ? `**Type:** ${vulnType}` : ""}
${endpoint ? `**Endpoint:** ${endpoint}` : ""}
${cweId ? `**CWE:** ${cweId}` : ""}
${cveIds ? `**CVE(s):** ${cveIds}` : ""}

**Description:**
${description}

Provide a clear, actionable explanation suitable for a product manager.

Repsonse Type: Plain text.

Output Structure:
What it is: 
Severity: 

Max 200 words`;

  try {
    const stream = await openai.chat.completions.create({
      model: "gpt-5-mini",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userPrompt },
      ],
      max_completion_tokens: 800,
      stream: true,
    });

    const encoder = new TextEncoder();
    const readable = new ReadableStream({
      async start(controller) {
        try {
          for await (const chunk of stream) {
            const delta = chunk.choices[0]?.delta?.content;
            if (delta) controller.enqueue(encoder.encode(delta));
          }
        } catch (err) {
          console.error("Stream error:", err);
          controller.error(err);
        } finally {
          controller.close();
        }
      },
    });

    return new Response(readable, {
      headers: {
        "Content-Type": "text/plain; charset=utf-8",
        "Transfer-Encoding": "chunked",
      },
    });
  } catch (err) {
    console.error("Explain vulnerability error:", err);
    return NextResponse.json(
      { error: "Failed to generate explanation" },
      { status: 500 },
    );
  }
}
