"""Tests for exploitation engine — backoff, strategy rotation."""

from nazitest.exploitation.backoff import BackoffManager
from nazitest.exploitation.strategy import StrategyRotator
from nazitest.models.types import DeliveryMethod, EncodingType


class TestBackoffManager:
    def test_delay_increases(self) -> None:
        bm = BackoffManager(max_delay=60.0, jitter_ratio=0.0)
        d0 = bm.calculate_delay(0)  # 2^0 = 1
        d1 = bm.calculate_delay(1)  # 2^1 = 2
        d2 = bm.calculate_delay(2)  # 2^2 = 4
        assert d0 < d1 < d2

    def test_delay_capped(self) -> None:
        bm = BackoffManager(max_delay=10.0, jitter_ratio=0.0)
        d = bm.calculate_delay(100)  # Would be huge without cap
        assert d <= 10.0

    def test_jitter_adds_randomness(self) -> None:
        bm = BackoffManager(max_delay=60.0, jitter_ratio=0.5)
        delays = {bm.calculate_delay(3) for _ in range(20)}
        # With jitter, we should get different values
        assert len(delays) > 1


class TestStrategyRotator:
    def test_encoding_rotation(self) -> None:
        rotator = StrategyRotator()
        seen = set()
        for _ in range(len(EncodingType)):
            enc = rotator.next_encoding()
            seen.add(enc)
        # Should have cycled through all encodings
        assert len(seen) == len(EncodingType)

    def test_delivery_rotation(self) -> None:
        rotator = StrategyRotator()
        seen = set()
        for _ in range(len(DeliveryMethod)):
            d = rotator.next_delivery()
            seen.add(d)
        assert len(seen) == len(DeliveryMethod)

    def test_fingerprint_rotation(self) -> None:
        rotator = StrategyRotator()
        seen = set()
        for _ in range(5):
            fp = rotator.next_fingerprint()
            seen.add(fp)
        assert len(seen) >= 3  # Should get at least 3 different fingerprints

    def test_full_rotation(self) -> None:
        rotator = StrategyRotator()
        rot = rotator.get_rotation()
        assert "encoding" in rot
        assert "delivery" in rot
        assert "fingerprint" in rot
        assert "user_agent" in rot
        assert isinstance(rot["encoding"], EncodingType)
        assert isinstance(rot["delivery"], DeliveryMethod)

    def test_reset(self) -> None:
        rotator = StrategyRotator()
        rotator.next_encoding()
        rotator.next_delivery()
        rotator.reset()
        assert rotator._used_encodings == []
        assert rotator._used_deliveries == []

    def test_wraps_around(self) -> None:
        rotator = StrategyRotator()
        # Request more than total available — should wrap
        for _ in range(len(EncodingType) + 3):
            enc = rotator.next_encoding()
            assert isinstance(enc, EncodingType)
